## Cluster configs

apiVersion: cluster.x-k8s.io/v1alpha3
kind: Cluster
metadata:
  name: talos-e2e-{{TAG}}-azure
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
        - 192.168.0.0/16
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
    kind: AzureCluster
    name: talos-e2e-{{TAG}}-azure
  controlPlaneRef:
    kind: TalosControlPlane
    apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
    name: talos-e2e-{{TAG}}-azure-controlplane
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
kind: AzureCluster
metadata:
  name: talos-e2e-{{TAG}}-azure
spec:
  location: centralus
  networkSpec:
    vnet:
      name: talos-e2e-{{TAG}}-azure-vnet
      cidrBlock: 10.0.0.0/16
    subnets:
      - name: talos-e2e-{{TAG}}-azure-controlplane-subnet
        role: control-plane
        cidrBlock: 10.0.1.0/24 
        securityGroup:
          name: talos-e2e-{{TAG}}-azure-controlplane-nsg
          ingressRule:
            - name: "allow_all_cp"
              description: "all the things (controlplane)"
              priority: 102
              protocol: "*"
              sourcePorts: "*"
              destinationPorts: "*"
              source: "*"
              destination: "*"
      - name: talos-e2e-{{TAG}}-azure-node-subnet
        role: node
        cidrBlock: 10.0.2.0/24
        securityGroup:
          name: talos-e2e-{{TAG}}-azure-node-nsg
          ingressRule:
            - name: "allow_all_node"
              description: "all the things (nodes)"
              priority: 103
              protocol: "*"
              sourcePorts: "*"
              destinationPorts: "*"
              source: "*"
              destination: "*"
  resourceGroup: talos
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
kind: AzureMachineTemplate
metadata:
  name: talos-e2e-{{TAG}}-azure-controlplane
spec:
  template:
    spec:
      location: centralus
      osDisk:
        diskSizeGB: 10
        managedDisk:
          storageAccountType: Premium_LRS
        osType: Linux
      image: 
        id: "/subscriptions/64739c64-c063-4c9d-bf2c-d1191ed8befa/resourceGroups/talos/providers/Microsoft.Compute/images/talos-e2e-{{TAG}}"
      vmSize: "Standard_D2s_v3"
      sshPublicKey: "{{AZURE_DUMMY_SSH_PUB}}"
      allocatePublicIP: true
---
apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
kind: TalosControlPlane
metadata:
  name: talos-e2e-{{TAG}}-azure-controlplane
spec:
  version: v1.18.3
  replicas: 3
  infrastructureTemplate:
    kind: AzureMachineTemplate
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
    name: talos-e2e-{{TAG}}-azure-controlplane
  controlPlaneConfig:
    init:
      generateType: init
    controlplane:
      generateType: controlplane
---
## Worker deployment configs

apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: TalosConfigTemplate
metadata:
  name: talos-e2e-{{TAG}}-azure-workers
  namespace: default
spec:
  template:
    spec:
      generateType: join
---
apiVersion: cluster.x-k8s.io/v1alpha3
kind: MachineDeployment
metadata:
  labels:
    cluster.x-k8s.io/cluster-name: talos-e2e-{{TAG}}-azure
  name: talos-e2e-{{TAG}}-azure-workers
  namespace: default
spec:
  clusterName: talos-e2e-{{TAG}}-azure
  replicas: 3
  selector:
    matchLabels:
      cluster.x-k8s.io/cluster-name: talos-e2e-{{TAG}}-azure
  template:
    metadata:
      labels:
        cluster.x-k8s.io/cluster-name: talos-e2e-{{TAG}}-azure
    spec:
      clusterName: talos-e2e-{{TAG}}-azure
      bootstrap:
        configRef:
          apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
          kind: TalosConfigTemplate
          name: talos-e2e-{{TAG}}-azure-workers
          namespace: default
      infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
        kind: AzureMachineTemplate
        name: talos-e2e-{{TAG}}-azure-workers
        namespace: default
      version: 1.18.3
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
kind: AzureMachineTemplate
metadata:
  name: talos-e2e-{{TAG}}-azure-workers
  namespace: default
spec:
  template:
    spec:
      location: centralus
      osDisk:
        diskSizeGB: 10
        managedDisk:
          storageAccountType: Premium_LRS
        osType: Linux
      image: 
        id: "/subscriptions/64739c64-c063-4c9d-bf2c-d1191ed8befa/resourceGroups/talos/providers/Microsoft.Compute/images/talos-e2e-{{TAG}}"
      vmSize: "Standard_D2s_v3"
      sshPublicKey: "{{AZURE_DUMMY_SSH_PUB}}"
      allocatePublicIP: true
