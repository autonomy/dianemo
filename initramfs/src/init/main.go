// +build linux

package main

import "C"

import (
	"flag"
	"log"
	"net/http"
	"os"
	"os/exec"

	"github.com/autonomy/dianemo/initramfs/src/init/pkg/constants"
	"github.com/autonomy/dianemo/initramfs/src/init/pkg/docker"
	"github.com/autonomy/dianemo/initramfs/src/init/pkg/kubernetes"
	"github.com/autonomy/dianemo/initramfs/src/init/pkg/mount"
	"github.com/autonomy/dianemo/initramfs/src/init/pkg/mount/cgroups"
	"github.com/autonomy/dianemo/initramfs/src/init/pkg/process"
	"github.com/autonomy/dianemo/initramfs/src/init/pkg/switchroot"
)

var (
	switchRoot *bool
)

func depmod() error {
	cmd := exec.Command("/bin/depmod", []string{}...)
	cmd.Stdout = os.Stdout
	cmd.Stderr = os.Stderr
	err := cmd.Start()
	if err != nil {
		return err
	}
	return nil
}

func hang(errs []error) {
	for _, err := range errs {
		log.Println(err.Error())
	}

	// Hang infinitely to avoid a kernel panic.
	select {}
}

func init() {
	log.SetFlags(log.Lshortfile | log.Ldate | log.Lmicroseconds | log.Ltime)
	os.Setenv("PATH", constants.PATH)

	switchRoot = flag.Bool("switch-root", false, "perform a switch_root")
	flag.Parse()
}

func main() {
	if !*switchRoot {
		// Mount the initial file systems.
		if err := mount.Mount(); err != nil {
			hang([]error{err})
		}
		// TODO: Execute user data.
		// Move the initial file systems to the new root.
		if err := mount.Move(); err != nil {
			hang([]error{err})
		}
		// Mount the cgroups file systems to the new root.
		if err := cgroups.Mount(); err != nil {
			hang([]error{err})
		}
		// Perform the equivalent of switch_root.
		// See https://github.com/karelzak/util-linux/blob/master/sys-utils/switch_root.c
		if err := switchroot.Switch(); err != nil {
			hang([]error{err})
		}
	}

	// Load the kernel modules.
	if err := depmod(); err != nil {
		hang([]error{err})
	}

	// Start the processes essential to running Kubernetes.
	processManager := process.NewManager()
	processManager.Start(&process.Docker{})
	processManager.Start(&process.Kubeadm{})
	processManager.Start(&process.Kubelet{})

	// TODO: Authn/Authz.
	// TODO: Errors API that admins can use to debug.
	// An endpoint for retreiving the admin.conf generated by kubeadm.
	http.HandleFunc("/kubeconfig", kubernetes.KubeConfigHandleFunc)
	// An endpoint for listing the running containers.
	http.HandleFunc("/containers", docker.ContainersHandleFunc)
	// An endpoint for streaming a process' stdout/stderr.
	http.HandleFunc("/logs/", process.StreamHandleFunc)
	// TODO: TLS only.
	http.ListenAndServe(":8080", nil)
}
